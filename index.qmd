---
title: "Analysis Cercospora Proth"
author: "Anderson Cerutti"
format: html
editor: visual
date: "January 20 2026"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: true
    toc_float: 
      collapsed: true
    code_folding: hide
    theme: united
description: "some description ..."
editor_options: 
  chunk_output_type: inline
---

# Data and packages

## Packages

```{r}
library(tidyverse)
library(lme4)
library(emmeans)
library(ggplot2)
library(car)
library(performance)
library(patchwork)
library(sjPlot)
library(flextable)
library(multcomp)
library(multcompView)

conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
```

## Data

```{r}
PROTH_data <- readxl::read_xlsx("Data/Cercospora_PROTH_measure.xlsx","PROTH")
PROTH_desc <- readxl::read_xlsx("Data/Cercospora_PROTH_description.xlsx","PROTH")
```

```{r}
PROTH_data_disease <-  PROTH_data
PROTH_data_yield   <-  PROTH_desc
  
n_lesion_plot <- PROTH_data_disease %>%
  filter(lesion_n > 0) %>%
  group_by(year, trial_ID, plot) %>%
  summarise(
    CPB = mean(CPB, na.rm = TRUE),
    n_lesion = n(),
    .groups = "drop",
    inc  = (n_lesion * 100)/50)

PROTH_yield_data <- PROTH_data_yield %>% 
  mutate(
    yld_a = weight * ((1-(moist/100))/(1-0.12))*(43560/(4.66*16)),
    yld_h = yld_a * 1.12085) %>% 
    dplyr::select(year, trial_ID, trial, env, field, plot, blk, trt, 
                  gen, stage, rate, total, head, yld_a, yld_h, NBLS)

CERC_PROTH_data <- right_join(PROTH_yield_data, n_lesion_plot,
                  by = c("year","trial_ID","plot")) %>%
                  filter(!field %in% c("WIN")) %>%
  mutate(
    pressure = ifelse(inc > 64, "high", "low"))
```


## Analysis

### Yeald

```{r}
mix_yld  <- lmer(yld_h ~ 1 + ( 1 | blk), data=CERC_PROTH_data, REML=F)
mix_yld1 <- lmer(yld_h ~ inc + (inc | blk), data=CERC_PROTH_data, REML=F)
mix_yld2 <- lmer(yld_h ~ inc + (1 | inc), data=CERC_PROTH_data, REML=F)
mix_yld3 <- lmer(yld_h ~ inc + (1 | blk), data=CERC_PROTH_data, REML=F)
mix_yld4 <- lmer(yld_h ~ inc + (1 | trt:blk), data=CERC_PROTH_data)
mix_yld5 <- lmer(yld_h ~ inc * gen * stage * (1 | trt:blk), data=CERC_PROTH_data)
mix_yld6 <- lmer(yld_h ~ inc * stage * (1 | trt:blk), data=CERC_PROTH_data)
mix_yld7 <- lmer(yld_h ~ gen * stage * (1 | trt:blk), data=CERC_PROTH_data)

AIC(mix_yld, mix_yld1, mix_yld2, mix_yld3, mix_yld4, mix_yld5, mix_yld6, mix_yld7)
BIC(mix_yld, mix_yld1, mix_yld2, mix_yld3, mix_yld4, mix_yld5, mix_yld6, mix_yld7)
anova(mix_yld5, mix_yld6, mix_yld7)
summary(mix_yld5)
summary(mix_yld6)
summary(mix_yld7)

YLD_emm_inc <- emmeans(mix_yld5, ~ gen)
print(cld(YLD_emm_inc, alpha = 0.05, Letters = letters))

#lmer(inc ~ trt * gen * env + #
#      (1|year), 
#     data = CERC_PROTH_data)
```

```{r}
ggplot(CERC_PROTH_data, aes(x = yld_h)) +
  geom_histogram(bins = 30, fill = "steelblue") +
  theme_minimal()
```

```{r}
# Boxplot de produtividade por estágio
ggplot(CERC_PROTH_data, aes(x = stage, y = yld_h)) +
  geom_boxplot(fill = "skyblue") +
  theme_minimal()

# Relação entre CPB e produtividade
ggplot(CERC_PROTH_data, aes(x = CPB, y = yld_h)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  theme_minimal()

# Relação entre NBLS e produtividade
ggplot(CERC_PROTH_data, aes(x = NBLS, y = yld_h)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  theme_minimal()

#modelo <- lm(yld_h ~ CPB + NBLS + inc + pressure, data = CERC_PROTH_data)

#summary(modelo)
#Anova(modelo)
#AIC(modelo)
#BIC(modelo)

ggplot(CERC_PROTH_data, aes(x = rate, y = yld_h, color = factor(trt))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()

```