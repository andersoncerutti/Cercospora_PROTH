---
title: "Analysis Cercospora Proth"
author: "Anderson Cerutti"
format:
  html:
    code-fold: false
    smooth-scroll: true
    fig-width: 16
    fig-height: 10
    css: styles.css
    self-contained: true
    df-print: paged
    #code-tools:
      #source: true
      #toggle: true
      #caption: "Source code"
theme: "lumen"
toc: true
toc-location: left
toc-depth: 10
fontcolor: "black" # {html} Color of text.
linkcolor: "#007FFF" # {html, pdf, beamer} Color of link text.
reference-location: "margin"
colortheme: "black"
highlight: monochrome
warning: false
cache: true
---

# Data and packages

## Packages

```{r}
library(tidyverse)
library(lme4)
library(emmeans)
library(ggplot2)
library(car)
library(performance)
library(patchwork)
library(sjPlot)
library(flextable)
library(multcomp)
library(multcompView)

conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
```

## Data

PROTH_desc

```{r}
PROTH_data <- readxl::read_xlsx("Data/Cercospora_PROTH_measure.xlsx","PROTH")
PROTH_desc <- readxl::read_xlsx("Data/Cercospora_PROTH_description.xlsx", "PROTH")
```

```{r}
PROTH_data_disease <-  PROTH_data
PROTH_data_yield   <-  PROTH_desc
  
n_lesion_plot <- PROTH_data_disease %>%
  filter(lesion_n > 0) %>%
  group_by(year, trial_ID, plot) %>%
  summarise(
    CPB = mean(CPB, na.rm = TRUE),
    n_lesion = n(),
    .groups = "drop",
    inc  = (n_lesion * 100)/50)

PROTH_yield_data <- PROTH_data_yield %>% 
  mutate(
     yld = weight_12/(80/43560), 
     kg_ha = yld*1.2085) %>% 
  dplyr::select(year, trial_ID, trial, env, field, plot, blk, trt, 
                  gen, fung, stage, rate, total, head, yld, kg_ha, NBLS)

CERC_PROTH_data <- right_join(PROTH_yield_data, n_lesion_plot,
                  by = c("year","trial_ID","plot")) %>%
                  filter(!field %in% c("WIN")) %>%
  mutate(
    pressure = ifelse(inc > median(inc), "high", "low"))

CERC_PROTH_data
```

## Analysis

### Descriptive

```{r}
# Produtividade
ggplot(CERC_PROTH_data, aes(x = rate, y = kg_ha, color = trt)) +
  geom_boxplot() +
  geom_point(size=2) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  facet_wrap(~env)
```

```{r}

# Produtividade X Rate (BLK)
ggplot(CERC_PROTH_data, aes(x = rate, y = kg_ha, color = trt)) +
  geom_boxplot() +
  geom_point(size=2) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  facet_wrap(~blk)
```

```{r}
# Relação entre CPB e produtividade
ggplot(CERC_PROTH_data, aes(x = CPB, y = kg_ha, group = stage, color = stage)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()
```

```{r}
# Relação entre NBLS e produtividade
ggplot(CERC_PROTH_data, aes(NBLS, kg_ha, group = stage, color = stage)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal()
```

```{r}
ggplot(CERC_PROTH_data, aes(x= pressure, kg_ha, group = pressure)) +
  geom_boxplot()
```

### Fitting

```{r}
mix_yld  <- lmer(kg_ha ~ 1 + ( 1 | blk), data=CERC_PROTH_data, REML=F)
mix_yld1 <- lmer(kg_ha ~ pressure + (pressure | blk), data=CERC_PROTH_data, REML=F)
mix_yld2 <- lmer(kg_ha ~ pressure + (1 | pressure), data=CERC_PROTH_data, REML=F)
mix_yld3 <- lmer(kg_ha ~ pressure + (1 | blk), data=CERC_PROTH_data, REML=F)
mix_yld4 <- lmer(kg_ha ~ pressure + (1 | trt/blk), data=CERC_PROTH_data, REML=F)
mix_yld5 <- lmer(kg_ha ~ pressure * rate * (1 | trt/blk), data=CERC_PROTH_data, REML=F)
mix_yld6 <- lmer(kg_ha ~ pressure * rate * (1 | pressure/blk), data=CERC_PROTH_data, REML=F)
mix_yld7 <- lmer(kg_ha ~ rate * (1 | trt/blk), data=CERC_PROTH_data, REML=F)

AIC(mix_yld, mix_yld1, mix_yld2, mix_yld3, mix_yld4, mix_yld5, mix_yld6, mix_yld7)
BIC(mix_yld, mix_yld1, mix_yld2, mix_yld3, mix_yld4, mix_yld5, mix_yld6, mix_yld7)
anova(mix_yld5, mix_yld6)
summary(mix_yld5)
summary(mix_yld6)
summary(mix_yld7)

YLD_emm_kg <- emmeans(mix_yld5, ~ rate * pressure)
print(cld(YLD_emm_kg, alpha = 0.05, Letters = letters))

```
